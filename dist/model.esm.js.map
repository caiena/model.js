{"version":3,"file":"model.esm.js","sources":["../src/meta.js","../src/mixin.js","../src/mixins/attributable.js","../src/mixins/relatable.js","../src/mixins/translatable.js","../src/validators/datetime.js","../src/validators/presence.js","../src/validators/index.js","../src/mixins/validatable.js","../src/model.js"],"sourcesContent":["// utility function for metaprogramming\n\nimport _ from '@caiena/lodash-ext'\n\n\nfunction defineInternalProp(obj, prop, value) {\n  Object.defineProperty(obj, prop, {\n    enumerable: false,\n    writable: true,\n    configurable: true,\n    value\n  })\n}\n\n\n// checks for property in instance or its prototype\nfunction writableProp(instance, name) {\n  // avoiding reserved props (e.g. constructor) or names starting with $ - model.js \"meta\" props\n  if (_.includes(['constructor'], name) || _.startsWith(name, '$')) return false\n\n  let descriptor = null\n\n  if (instance.hasOwnProperty(name)) {\n    descriptor = Object.getOwnPropertyDescriptor(instance, name)\n  } else {\n    // falling back to prototype\n    let prototype = Object.getPrototypeOf(instance)\n    descriptor = Object.getOwnPropertyDescriptor(prototype, name)\n  }\n\n  return !!descriptor.set || (descriptor.writable === true)\n}\n\n\n// checks for property in instance or its prototype\nfunction writablePropNames(instance) {\n  let prototype = Object.getPrototypeOf(instance)\n  let propNames = _.chain(Object.getOwnPropertyNames(instance))\n    .concat(Object.getOwnPropertyNames(prototype))\n    .uniq()\n    .value()\n    .sort()\n\n  return _.filter(propNames, (name) => writableProp(instance, name))\n}\n\n\n// can't export default and import named destructuring. So we're exporting named (non-default).\n// https://github.com/babel/babel-loader/issues/194\nexport {\n  defineInternalProp,\n  writableProp,\n  writablePropNames\n}\n","// @see https://github.com/Vincit/objection.js/blob/2f7dd232aec1b1b3d880d10e75b169af2554ea91/lib/utils/mixin.js\nimport _ from '@caiena/lodash-ext'\n\n\nfunction mixin(Class, mixins) {\n  return mixins.reduce((MixedClass, Mixin) => Mixin(MixedClass), Class)\n}\n\n\nexport default mixin\n","import _                      from '@caiena/lodash-ext'\nimport Enum                   from '@caiena/enum'\nimport mixin                  from '../mixin'\nimport { defineInternalProp, writablePropNames } from '../meta'\n\n\n\nfunction defineAttr(obj, attrName, { get = null, set = null } = {}) {\n  if (!get) {\n    get = function get() {\n      return this.$attrs[attrName]\n    }\n  }\n\n  if (!set) {\n    set = function set(value) {\n      return this.$attrs[attrName] = value\n    }\n  }\n\n  Object.defineProperty(obj, attrName, {\n    get,\n    set,\n    configurable: true,\n    enumerable:   true\n  })\n}\n\nfunction defineEnum(obj, enumName, { get = null, set = null } = {}) {\n  // custom setter for enums\n  if (!set) {\n    set = function set(value) {\n      // ensures setting the key as attr value\n      let key = this.constructor.$enums[enumName].key(value)\n      return this.$attrs[enumName] = key\n    }\n  }\n\n  defineAttr(obj, enumName, { get, set })\n}\n\n\n\nfunction Attributable(Class) {\n\n  class AttributableClass extends Class {\n\n    // lazy evaluated $enums, using @caiena/enum\n    static get $enums() {\n      return this.$$enums = this.$$enums || _.reduce(this.enums, (result, enumeration, enumName) => {\n        if (enumeration instanceof Enum) {\n          result[enumName] = enumeration\n        } else {\n          result[enumName] = new Enum(enumeration)\n        }\n\n        return result\n      }, {})\n    }\n\n    constructor(...args) {\n      super(...args)\n\n      let klass = this.constructor\n\n      defineInternalProp(this, '$$attrs', {})\n\n      // handling enums first then attrs, avoiding overrides\n      // defining enums get/set properties\n      _.each(klass.enums, (enumeration, enumName) => {\n        // sanity check!\n        // enum must be defined in attrs list as well\n        if (!_.includes(klass.attrs, enumName)) {\n          throw new Error(`enum \"${enumName}\" is not listed as an attribute in model ${klass.name}`)\n        }\n\n        if (!_.has(this, enumName)) {\n          // first, check if it is defined in prototype\n          if (_.hasIn(this, enumName)) {\n            let _proto = Object.getPrototypeOf(this)\n            let _descr = Object.getOwnPropertyDescriptor(_proto, enumName)\n            defineEnum(this, enumName, { get: _descr.get, set: _descr.set })\n          } else {\n            defineEnum(this, enumName)\n          }\n        }\n      })\n\n      // defining attrs get/set properties\n      _.each(klass.attrs, (attrName) => {\n        if (!_.has(this, attrName)) {\n          // first, check if it is defined in prototype\n          if (_.hasIn(this, attrName)) {\n            let _proto = Object.getPrototypeOf(this)\n            let _descr = Object.getOwnPropertyDescriptor(_proto, attrName)\n            defineAttr(this, attrName, { get: _descr.get, set: _descr.set })\n          } else {\n            defineAttr(this, attrName)\n          }\n        }\n      })\n    }\n\n    get $attrs() {\n      // XXX: $attrs and $$attrs will be confusing...\n      return this.$$attrs\n    }\n\n    set $attrs(attrs) {\n      // TODO: remove old code\n      // return _.merge(this.$$attrs, attrs)\n\n      // set props, one-by-one, using setter method\n      let sanitizedAttrs = _.pick(attrs, this.constructor.attrs)\n      _.each(sanitizedAttrs, (value, name) => {\n        this[name] = value\n      })\n    }\n\n    // TODO: remove it?\n    get $props() {\n      let instance = this\n      let proto = Object.getPrototypeOf(this)\n      let propNames = _.chain(Object.getOwnPropertyNames(proto))\n        .concat(Object.getOwnPropertyNames(instance))\n        .filter((name) => !(_.includes(['constructor'], name) || _.startsWith(name, '$')))\n        .uniq()\n        .value()\n        .sort()\n\n      return _.reduce(propNames, (props, propName) => {\n        props[propName] = this[propName]\n        return props\n      }, {})\n    }\n\n    $blank(attrNameOrPath) {\n      return _.blank(this.$get(attrNameOrPath))\n    }\n\n    $enumValue(enumName) {\n      return this.constructor.$enums[enumName].value(this[enumName])\n    }\n\n    $get(attrNameOrPath) {\n      return _.get(this, attrNameOrPath)\n    }\n\n    $has(attrNameOrPath) {\n      // TODO: should it be _.hasIn(), to include inherited properties?\n      return _.has(this, attrNameOrPath)\n    }\n\n    $pick(...attrNamesOrPathes) {\n      return _.pick(this, ...attrNamesOrPathes)\n    }\n\n    $present(attrNameOrPath) {\n      return _.present(this.$get(attrNameOrPath))\n    }\n\n    $set(attrNameOrPath, value) {\n      return _.set(this, attrNameOrPath, value)\n    }\n  }\n\n  return AttributableClass\n}\n\n\nexport default Attributable\n","import _                      from '@caiena/lodash-ext'\nimport mixin                  from '../mixin'\nimport { defineInternalProp, writablePropNames } from '../meta'\n\n\n\nfunction belongsTo(instance, relationName, config, { get = null, set = null } = {}) {\n  if (!get) {\n    get = function get() {\n      return this.$relations[relationName]\n    }\n  }\n\n  if (!set) {\n    // providing a way to lazily evaluate related model class\n    let ModelClass = null\n    if (config.model.$$model) { // check if is a model class without circular dependency\n      ModelClass = config.model\n    } else if (typeof config.model === 'function') { // check if is a callable (function)\n      ModelClass = config.model()\n    } else {\n      ModelClass = config.model // default: assign it as a model class\n    }\n\n    set = function set(value) {\n      if (_.isArray(value)) throw new Error(\"can't assign an array to a belongsTo relation\")\n\n      if (value instanceof ModelClass) {\n        return this.$relations[relationName] = value\n      } else {\n        // construct model instance with value as attributes\n        return this.$relations[relationName] = new ModelClass(value)\n      }\n    }\n  }\n\n  Object.defineProperty(instance, relationName, {\n    get,\n    set,\n    configurable: true,\n    enumerable:   true\n  })\n}\n\n\nfunction hasMany(instance, relationName, config, { get = null, set = null } = {}) {\n  if (!get) {\n    get = function get() {\n      return this.$relations[relationName]\n    }\n  }\n\n  if (!set) {\n    // providing a way to lazily evaluate related model class\n    let ModelClass = null\n    if (config.model.$$model) { // check if is a model class without circular dependency\n      ModelClass = config.model\n    } else if (typeof config.model === 'function') { // check if is a callable (function)\n      ModelClass = config.model()\n    } else {\n      ModelClass = config.model // default: assign it as a model class\n    }\n\n    set = function set(values) {\n      if (values == null) { // null or undefined\n        return this.$relations[relationName] = []\n      }\n\n      if (!_.isArray(values)) throw new Error(\"can't assign a non-array value to a hasMany relation\")\n\n      let modelInstances = _.map(values, (value) => {\n        return value instanceof ModelClass ? value : new ModelClass(value)\n      })\n\n      return this.$relations[relationName] = modelInstances\n    }\n  }\n\n  Object.defineProperty(instance, relationName, {\n    get,\n    set,\n    configurable: true,\n    enumerable:   true\n  })\n}\n\n\nfunction defineRelation(instance, relationName, config, { get, set } = {}) {\n  switch (config.type) {\n    case 'belongsTo': {\n      return belongsTo(...arguments)\n    }\n    case 'hasMany': {\n      return hasMany(...arguments)\n    }\n    default: {\n      throw new Error(`Unknown relation type \"${type}\"`)\n    }\n  }\n}\n\n\n\n\nfunction Relatable(Class) {\n\n  class RelatableClass extends Class {\n\n    // lazy evaluated $relations\n    static get $relations() {\n      return this.$$relations = this.$$relations || _.reduce(this.relations, (result, config, name) => {\n        result[name] = config\n        return result\n      }, {})\n    }\n\n    constructor(...args) {\n      super(...args)\n\n      let klass = this.constructor\n\n      defineInternalProp(this, '$$relations', {})\n\n      // defining relations get/set properties\n      _.each(klass.relations, (config, relationName) => {\n        if (!_.has(this, relationName)) {\n          // first, check if it is defined in prototype\n          if (_.hasIn(this, relationName)) {\n            let _proto = Object.getPrototypeOf(this)\n            let _descr = Object.getOwnPropertyDescriptor(_proto, relationName)\n            defineRelation(this, relationName, config, { get: _descr.get, set: _descr.set })\n          } else {\n            defineRelation(this, relationName, config)\n          }\n        }\n      })\n    }\n\n    get $relations() {\n      // XXX: $relations and $$relations will be confusing...\n      return this.$$relations\n    }\n  }\n\n  return RelatableClass\n}\n\n\nexport default Relatable\n","import _    from '@caiena/lodash-ext'\nimport i18n from '../i18n'\n\n\nfunction Translatable(Class) {\n  class TranslatableClass extends Class {\n    static get i18nScope() {\n      return `models.${_.underscore(this.name)}`\n    }\n\n    static $tModelName({ count = 1 } = {}) {\n      return i18n.t(this.i18nScope, { count })\n    }\n\n    static $tAttr(attrName, options = {}) {\n      let scope = `${this.i18nScope}.attributes`\n      return i18n.t(attrName, _.defaults({}, options, { scope }))\n    }\n\n    static $tEnum(enumName, enumValue = undefined, options = {}) {\n      let scope = this.i18nScope\n      let key = null\n\n      if (enumValue === undefined) {\n        // .attributes.${enumName}\n        scope += '.attributes'\n        key = enumName\n      } else {\n        // .enums.${enumName}.${enumValue}\n        scope += `.enums.${enumName}`\n        key = enumValue\n      }\n\n      return i18n.t(key, _.defaults({}, options, { scope }))\n    }\n\n    // TODO: localize attribute\n    // $l(attrName) {\n    //  // checkout type definition for date or datetime\n    //  // use $l('date', attrName)\n    //  // or  $l('time', attrName)\n    // }\n  }\n\n  return TranslatableClass\n}\n\n\nexport default Translatable\n","// @see https://validatejs.org/#validators-datetime\n// We're addming moment\n\nimport validate from 'validate.js'\nimport _        from '@caiena/lodash-ext'\nimport moment   from 'moment'\n\n\n// Before using it we must add the parse and format functions\n// Here is a sample implementation using moment.js\nvalidate.extend(validate.validators.datetime, {\n  // The value is guaranteed not to be null or undefined but otherwise it\n  // could be anything.\n  parse(value, options) {\n    // return +moment.utc(value)\n    return moment.utc(value)\n  },\n  // Input is a unix timestamp\n  format(value, options) {\n    var format = options.dateOnly ? 'YYYY-MM-DD' : 'YYYY-MM-DD hh:mm:ss'\n    return moment.utc(value).format(format)\n  }\n})\n\n\nexport default validate.validators.datetime\n","import validate from 'validate.js'\nimport _        from '@caiena/lodash-ext'\n\n// XXX overwriting presence validator.\n//\nfunction presence(value, options, key, attrs) {\n  let opts = _.merge({}, this.options, options)\n\n  if (_.blank(value)) {\n    return opts.message || this.message || \"can't be blank\";\n  }\n\n  // returning nothing means \"is valid\"\n}\n\nvalidate.validators.presence = presence\n\nexport default presence\n","// register all custom validators\nimport './datetime'\nimport './presence'\n\nexport default {}\n","import _        from '@caiena/lodash-ext'\nimport validate from 'validate.js'\nimport _validators from '../validators'\n\n\nfunction Validatable(Class) {\n  const meta = {\n    instance: {\n      $errors: {}\n    }\n  }\n\n  class ValidatableClass extends Class {\n    get $errors() {\n      return meta.instance.$errors\n    }\n\n    async $validate() {\n      let constraints = this.constructor.constraints\n\n      // adapting api to .then(success, error) to .then(success).catch(error)\n      return new Promise((resolve, reject) => {\n        // - cleanAttributes: false - to tell validatejs not to delete empty or without constraint attributes\n        // @see https://validatejs.org/#validate-async\n        //   > Besides accepting all options as the non async validation function it also accepts\n        //   > two additional options; cleanAttributes which, unless false, makes validate.async\n        //   > call validate.cleanAttributes before resolving the promise (...)\n        // @see https://validatejs.org/#utilities-clean-attributes\n        validate.async(this, constraints, { cleanAttributes: false})\n          .then(\n            function success(attributes) {\n              // reset errors\n              meta.instance.$errors = {}\n              resolve(true)\n            },\n\n            function error(errors) {\n              if (errors instanceof Error) {\n                // runtime Error. Just throw it\n                // reset errors\n                meta.instance.$errors = {}\n                reject(errors)\n              } else {\n                // validation error.\n                // assign to $errors\n                meta.instance.$errors = errors\n                resolve(false)\n              }\n            })\n      })\n    }\n  }\n\n  return ValidatableClass\n}\n\n\nexport default Validatable\n","import _                     from '@caiena/lodash-ext'\nimport { writablePropNames } from './meta'\nimport mixin                 from './mixin'\nimport Attributable          from './mixins/attributable'\nimport Relatable             from './mixins/relatable'\nimport Translatable          from './mixins/translatable'\nimport Validatable           from './mixins/validatable'\n\n\nclass Base {\n  static get attrs()     { return [] }\n  static get enums()     { return {} }\n  static get virtuals()  { return [] }\n}\n\nclass Model extends mixin(Base, [Attributable, Relatable, Translatable, Validatable]) {\n  static get $$model() { return true } // allow for checking if is a model clas\n\n  // using \"props\" as name to make it explicit that we'll set any enumerable \"property\" in the instance\n  // (JavaScript land - getOwnPropertyDescriptor() and prototype)\n  constructor(props = {}, { undefs = true } = {}) {\n    super()\n\n    let propNames = writablePropNames(this)\n    let sanitizedProps = _.pick(props, propNames)\n\n    if (undefs) {\n      // start all props with undefined, allowing them to be observed (rxjs, Vue, ...)\n      let undefProps = _.reduce(propNames, (undefProps, name) => {\n        undefProps[name] = undefined\n        return undefProps\n      }, {})\n\n      // adding undefs if not defined yet\n      // _.defaults(sanitizedProps, undefProps)\n      // XXX: using _.merge() here to keep properties names sorted\n      sanitizedProps = _.merge(undefProps, sanitizedProps)\n    }\n\n    // set props, one-by-one, using setter method\n    _.each(sanitizedProps, (value, name) => {\n      this[name] = value\n    })\n\n    this.$init() // hook for user land\n  }\n\n  $init() {\n    // override it in subclasses\n  }\n\n  toJSON({ pick = [], omit = [], virtuals = false, undefs = false } = {}) {\n    let json = _.clone(this.$attrs)\n\n    if (!undefs) {\n      json = _.pickBy(json, (val, key) => !_.isUndefined(val))\n    }\n\n    if (virtuals) {\n      _.merge(json, _.pick(this, this.constructor.virtuals))\n    }\n\n    if (_.present(omit)) {\n      json = _.omit(json, omit)\n    }\n\n    if (_.present(pick)) {\n      json = _.pick(json, pick)\n    }\n\n    return json\n  }\n\n  $serialize(...args) {\n    return this.toJSON(...args)\n  }\n}\n\n\nexport default Model\n"],"names":["defineInternalProp","obj","prop","value","Object","defineProperty","enumerable","writable","configurable","writableProp","instance","name","_","includes","startsWith","descriptor","hasOwnProperty","getOwnPropertyDescriptor","prototype","getPrototypeOf","set","writablePropNames","propNames","chain","getOwnPropertyNames","concat","uniq","sort","filter","mixin","Class","mixins","reduce","MixedClass","Mixin","defineAttr","attrName","get","$attrs","defineEnum","enumName","key","constructor","$enums","Attributable","AttributableClass","$$enums","enums","result","enumeration","Enum","args","klass","each","attrs","Error","has","hasIn","_proto","_descr","attrNameOrPath","blank","$get","attrNamesOrPathes","pick","present","$$attrs","sanitizedAttrs","proto","props","propName","belongsTo","relationName","config","$relations","ModelClass","model","$$model","isArray","hasMany","values","modelInstances","map","defineRelation","type","arguments","Relatable","RelatableClass","$$relations","relations","Translatable","TranslatableClass","count","i18n","t","i18nScope","options","scope","defaults","enumValue","undefined","underscore","validate","extend","validators","datetime","parse","moment","utc","format","dateOnly","presence","opts","merge","message","Validatable","meta","$errors","ValidatableClass","constraints","Promise","resolve","reject","async","cleanAttributes","then","success","attributes","error","errors","Base","Model","undefs","sanitizedProps","undefProps","$init","omit","virtuals","json","clone","pickBy","val","isUndefined","toJSON"],"mappings":"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"}